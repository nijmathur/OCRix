@startuml Document Scanning Workflow
!theme plain
skinparam shadowing false

title OCRix - Document Scanning Sequence Diagram

actor User
participant "ScannerScreen" as UI
participant "ScannerNotifier" as Notifier
participant "CameraService" as Camera
participant "OCRService" as OCR
participant "ImageProcessingService" as ImgProc
participant "DocumentNotifier" as DocNotifier
participant "DatabaseService" as DB
participant "AuditLoggingService" as Audit

== Camera Initialization ==
User -> UI: Open scanner
activate UI
UI -> Notifier: initializeCamera()
activate Notifier
Notifier -> Camera: initialize()
activate Camera
Camera -> Camera: Check permissions
Camera -> Camera: Initialize camera controller
Camera --> Notifier: Camera ready
deactivate Camera
Notifier --> UI: State updated
deactivate Notifier
UI -> UI: Show camera preview
deactivate UI

== Image Capture ==
User -> UI: Press capture button
activate UI
UI -> Notifier: captureImage()
activate Notifier
Notifier -> Camera: captureImage()
activate Camera
Camera -> Camera: Take picture
Camera -> Camera: Save to temp file
Camera --> Notifier: imagePath
deactivate Camera
Notifier -> Notifier: Update state with captured image
Notifier --> UI: Image captured
deactivate Notifier
UI -> UI: Show preview with save dialog
deactivate UI

== OCR & Save ==
User -> UI: Enter title, tags and tap Save
activate UI
UI -> DocNotifier: scanDocument(imagePath, title, tags, type)
activate DocNotifier

DocNotifier -> ImgProc: processImageForStorage(imagePath)
activate ImgProc
ImgProc -> ImgProc: Optimize image
ImgProc -> ImgProc: Generate thumbnail
ImgProc --> DocNotifier: processedImageData, thumbnailData
deactivate ImgProc

DocNotifier -> OCR: extractTextFromImage(imagePath)
activate OCR
OCR -> OCR: Load image as InputImage
OCR -> OCR: Use Google ML Kit TextRecognizer
OCR --> DocNotifier: extractedText
deactivate OCR

alt No document type specified
    DocNotifier -> OCR: categorizeDocument(extractedText)
    activate OCR
    OCR -> OCR: Analyze text for keywords
    OCR -> OCR: Assign category
    OCR --> DocNotifier: documentType
    deactivate OCR
end

DocNotifier -> DocNotifier: Create Document object
DocNotifier -> DB: insertDocument(document)
activate DB
DB -> DB: Encrypt if encryption enabled
DB -> DB: Insert into SQLite
DB -> DB: Update FTS5 search index
DB --> DocNotifier: documentId
deactivate DB

DocNotifier -> Audit: logInfoAction(CREATE, documentId)
activate Audit
Audit -> Audit: Get previous audit entry
Audit -> Audit: Calculate checksum with chain link
Audit -> DB: insertAuditEntry(auditLog)
activate DB
DB --> Audit: Success
deactivate DB
deactivate Audit

DocNotifier -> DocNotifier: Update state with new document
DocNotifier --> UI: Document saved
deactivate DocNotifier
UI --> User: Show success message
deactivate UI

User -> UI: Navigate to home
UI -> UI: Refresh document list

@enduml
