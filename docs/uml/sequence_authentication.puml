@startuml Authentication Workflow
!theme plain
skinparam shadowing false

title OCRix - Authentication & Authorization Sequence Diagram

actor User
participant "AppInitializer" as Init
participant "LoginScreen" as UI
participant "AuthNotifier" as AuthNotifier
participant "AuthService" as AuthSvc
participant "GoogleSignIn" as Google
participant "BiometricAuthNotifier" as BioNotifier
participant "LocalAuthentication" as LocalAuth
participant "AuditLoggingService" as Audit
participant "DatabaseService" as DB
participant "HomeScreen" as Home

== App Launch ==
User -> Init: Start app
activate Init
Init -> AuthNotifier: Check authentication state
activate AuthNotifier
AuthNotifier -> AuthNotifier: Check stored auth token
alt User not authenticated
    AuthNotifier --> Init: Not authenticated
    deactivate AuthNotifier
    Init -> UI: Navigate to LoginScreen
    activate UI
    deactivate Init
else User authenticated but biometric enabled
    AuthNotifier --> Init: Authenticated, biometric required
    deactivate AuthNotifier
    Init -> BioNotifier: Trigger biometric auth
    note right: Flow continues in\nBiometric Auth section
end

== Google Sign-In ==
User -> UI: Tap "Sign in with Google"
UI -> AuthNotifier: signIn()
activate AuthNotifier
AuthNotifier -> AuthSvc: signIn()
activate AuthSvc

AuthSvc -> Google: signIn()
activate Google
Google -> Google: Show Google account picker
User -> Google: Select account & authorize
Google -> Google: Generate auth token
Google --> AuthSvc: GoogleSignInAccount
deactivate Google

AuthSvc -> AuthSvc: Extract user info
AuthSvc -> AuthSvc: Create AuthUser object
AuthSvc --> AuthNotifier: AuthUser
deactivate AuthSvc

AuthNotifier -> AuthNotifier: Update state with user
AuthNotifier -> Audit: logInfoAction(LOGIN, userId)
activate Audit
Audit -> Audit: Create audit entry with chain link
Audit -> DB: insertAuditEntry(auditLog)
activate DB
DB --> Audit: Success
deactivate DB
deactivate Audit

AuthNotifier --> UI: Sign in successful
deactivate AuthNotifier

alt Biometric authentication enabled
    UI -> BioNotifier: Check if biometric is enabled
    activate BioNotifier
    BioNotifier -> BioNotifier: Load settings from DB
    BioNotifier --> UI: Biometric enabled
    deactivate BioNotifier
    UI -> UI: Navigate to biometric prompt
    note right: Flow continues in\nBiometric Auth section
else Biometric not enabled
    UI -> Home: Navigate to HomeScreen
    deactivate UI
    activate Home
    Home -> Home: Load documents
    deactivate Home
end

== Biometric Authentication ==
User -> BioNotifier: authenticate()
activate BioNotifier
BioNotifier -> LocalAuth: authenticate()
activate LocalAuth
LocalAuth -> LocalAuth: Check biometric availability
LocalAuth -> LocalAuth: Show biometric prompt (fingerprint/face)
User -> LocalAuth: Provide biometric
LocalAuth -> LocalAuth: Verify biometric

alt Biometric verification successful
    LocalAuth --> BioNotifier: Authentication successful
    deactivate LocalAuth
    BioNotifier -> BioNotifier: Update state: authenticated
    BioNotifier -> Audit: logInfoAction(BIOMETRIC_AUTH, userId)
    activate Audit
    Audit -> DB: insertAuditEntry(auditLog)
    activate DB
    DB --> Audit: Success
    deactivate DB
    deactivate Audit

    BioNotifier --> Home: Navigate to HomeScreen
    deactivate BioNotifier
    activate Home
    Home -> Home: Load documents
    deactivate Home

else Biometric verification failed
    LocalAuth --> BioNotifier: Authentication failed
    deactivate LocalAuth
    BioNotifier --> UI: Show error, fallback to login
    deactivate BioNotifier
    activate UI
    UI -> UI: Show retry or cancel options
    deactivate UI
end

== Sign Out ==
User -> Home: Tap Sign Out
activate Home
Home -> AuthNotifier: signOut()
activate AuthNotifier

AuthNotifier -> Audit: logInfoAction(LOGOUT, userId)
activate Audit
Audit -> DB: insertAuditEntry(auditLog)
activate DB
DB --> Audit: Success
deactivate DB
deactivate Audit

AuthNotifier -> AuthSvc: signOut()
activate AuthSvc
AuthSvc -> Google: signOut()
activate Google
Google -> Google: Clear auth tokens
Google --> AuthSvc: Success
deactivate Google
AuthSvc --> AuthNotifier: Signed out
deactivate AuthSvc

AuthNotifier -> AuthNotifier: Clear user state
AuthNotifier --> Home: Sign out successful
deactivate AuthNotifier

Home -> UI: Navigate to LoginScreen
deactivate Home
activate UI
deactivate UI

@enduml
