@startuml LLM Search Architecture
!theme plain
skinparam componentStyle rectangle

title OCRix LLM-Powered Search Architecture\nwith Security Layers

actor User

package "UI Layer (Flutter)" {
  [Search Tab UI] as UI
  [Query Input] as Input
  [Results Display] as Results
}

package "Security Layer" {
  [Input Sanitizer] as Sanitizer
  [SQL Validator] as Validator
  [Rate Limiter] as RateLimiter
  [Audit Logger] as AuditLog
}

package "LLM Layer" {
  [Model Selector] as Selector
  [Gemini Nano\n(AICore)] as GeminiNano
  [Phi-3 Mini\n(ONNX)] as Phi3
  [Prompt Builder] as PromptBuilder
}

package "Database Layer (Read-Only)" {
  database "Documents DB\n(Read-Only Connection)" as DB {
    [SELECT Only Executor] as Executor
  }
}

' User interactions
User --> Input : "find invoices\nfrom last month"

' Flow through security
Input --> Sanitizer : Raw query
Sanitizer --> RateLimiter : Check limits
RateLimiter --> PromptBuilder : Build prompt

' Model selection
PromptBuilder --> Selector : Request inference
Selector --> GeminiNano : If Android 14+
Selector --> Phi3 : Fallback

' SQL generation
GeminiNano --> Validator : Generated SQL
Phi3 --> Validator : Generated SQL
Validator --> Executor : Validated SELECT

' Execution and results
Executor --> DB : Execute query
DB --> Results : Document list
Results --> User : Display results

' Audit trail
Validator --> AuditLog : Log query
Executor --> AuditLog : Log execution

' Security annotations
note right of Sanitizer
  **Layer 1: Input Validation**
  - Length check (max 500 chars)
  - SQL injection detection
  - Character whitelist
  - Rate limit enforcement
end note

note right of Validator
  **Layer 2: SQL Validation**
  - SELECT-only enforcement
  - Table whitelist
  - LIMIT clause injection
  - No nested queries
  - Timeout protection
end note

note right of Executor
  **Layer 3: Database Protection**
  - Read-only connection
  - Transaction blocking
  - Result size limits
  - 5-second timeout
  **NO INSERT/UPDATE/DELETE**
end note

note left of GeminiNano
  **On-Device Processing**
  - No data leaves device
  - 1.8-3.8GB model
  - Android 14+ only
  - Google AICore integration
end note

note left of Phi3
  **Fallback Model**
  - 2.7GB (INT4 quantized)
  - Works on all devices
  - ONNX Runtime
  - MIT licensed
end note

@enduml
