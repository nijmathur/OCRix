name: Android Build

on:
    push:
        branches: [main, develop, feature/*]
    pull_request:
        branches: [main, develop]

jobs:
    build-android:
        name: Build Android APK
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.7"
                  channel: "stable"
                  cache: true

            - name: Cache Gradle packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            - name: Cache Flutter dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.pub-cache
                      ${{ github.workspace }}/.dart_tool
                  key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-pub-

            - name: Install dependencies
              run: flutter pub get

            - name: Verify Flutter setup
              run: flutter doctor -v

            - name: Free up disk space
              run: |
                  echo "Disk space before cleanup:"
                  df -h

                  # Remove unnecessary packages and files
                  sudo rm -rf /usr/share/dotnet
                  sudo rm -rf /usr/local/lib/android
                  sudo rm -rf /opt/ghc
                  sudo rm -rf /opt/hostedtoolcache/CodeQL
                  sudo docker image prune --all --force

                  echo "Disk space after cleanup:"
                  df -h

            - name: Run Flutter analyze
              run: |
                  echo "Running static analysis..."
                  flutter analyze > analyze_output.txt 2>&1 || true
                  cat analyze_output.txt

                  # Check if there are any errors (not warnings or info)
                  if grep -q "error ‚Ä¢" analyze_output.txt; then
                      echo "‚ùå Analysis found errors"
                      exit 1
                  fi

                  echo "‚úÖ Analysis passed (warnings and info are acceptable)"

            - name: Check ProGuard rules exist
              run: |
                  if [ ! -f android/app/proguard-rules.pro ]; then
                      echo "‚ùå ProGuard rules file not found"
                      exit 1
                  fi
                  echo "‚úÖ ProGuard rules file exists"

            - name: Build APK (Release)
              run: flutter build apk --release

            - name: Verify APK exists
              run: |
                  if [ ! -f build/app/outputs/flutter-apk/app-release.apk ]; then
                      echo "‚ùå Release APK not found"
                      exit 1
                  fi
                  echo "‚úÖ Release APK built successfully"
                  ls -lh build/app/outputs/flutter-apk/

            - name: Upload Release APK
              uses: actions/upload-artifact@v4
              with:
                  name: app-release-apk
                  path: build/app/outputs/flutter-apk/app-release.apk
                  retention-days: 30

            - name: Comment PR with build info
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      try {
                          const apkPath = 'build/app/outputs/flutter-apk/app-release.apk';
                          const stats = fs.statSync(apkPath);
                          const fileSizeInMB = (stats.size / (1024*1024)).toFixed(2);

                          const comment = `## üì¶ Android Build Successful

                          ‚úÖ Release APK built successfully!

                          **APK Size:** ${fileSizeInMB} MB
                          **Build Configuration:**
                          - Android Gradle Plugin: 8.7.3
                          - Kotlin: 2.1.0
                          - Gradle: 8.9
                          - compileSdk: 36
                          - Flutter: 3.35.7

                          üì• APK artifacts are available for download in the workflow run.
                          `;

                          github.rest.issues.createComment({
                              issue_number: context.issue.number,
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              body: comment
                          });
                      } catch (error) {
                          console.log('Could not generate build comment:', error.message);
                      }
