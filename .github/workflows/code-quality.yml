name: Code Quality

on:
    push:
        branches: [main, develop, feature/*]
    pull_request:
        branches: [main, develop]

jobs:
    code-quality:
        name: Code Quality Checks
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.7"
                  channel: "stable"
                  cache: true

            - name: Cache Flutter dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.pub-cache
                      ${{ github.workspace }}/.dart_tool
                  key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-pub-

            - name: Install dependencies
              run: flutter pub get

            - name: Verify Flutter setup
              run: flutter doctor -v

            - name: Run Flutter analyze
              run: |
                  echo "Running static analysis..."
                  flutter analyze > analyze_output.txt 2>&1 || true
                  cat analyze_output.txt

                  # Check if there are any errors (not warnings)
                  if grep -q "error ‚Ä¢" analyze_output.txt; then
                      echo "‚ùå Analysis found errors"
                      exit 1
                  fi

                  echo "‚úÖ Analysis passed"

            - name: Check Dart formatting
              run: |
                  echo "Checking Dart code formatting..."
                  dart format --set-exit-if-changed --output=none lib/ test/ || {
                      echo "‚ùå Code is not formatted correctly"
                      echo "Run 'dart format lib/ test/' to fix formatting"
                      exit 1
                  }
                  echo "‚úÖ Code formatting is correct"

            - name: Check for outdated dependencies
              run: |
                  echo "Checking for outdated dependencies..."
                  flutter pub outdated || true

            - name: Check for unused dependencies
              run: |
                  echo "Checking for unused dependencies..."
                  # This is informational only
                  flutter pub deps || true

            - name: Validate pubspec.yaml
              run: |
                  echo "Validating pubspec.yaml..."
                  flutter pub get --dry-run

            - name: Check for TODO/FIXME comments
              run: |
                  echo "Checking for TODO/FIXME comments..."
                  echo "Total TODOs: $(grep -r "TODO" lib/ | wc -l || echo 0)"
                  echo "Total FIXMEs: $(grep -r "FIXME" lib/ | wc -l || echo 0)"

            - name: Comment PR with quality report
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const { execSync } = require('child_process');

                      try {
                          const todoCount = execSync('grep -r "TODO" lib/ | wc -l || echo 0', { encoding: 'utf-8' }).trim();
                          const fixmeCount = execSync('grep -r "FIXME" lib/ | wc -l || echo 0', { encoding: 'utf-8' }).trim();

                          const comment = `## üîç Code Quality Report

                          ‚úÖ All quality checks passed!

                          **Checks performed:**
                          - ‚úÖ Static analysis (flutter analyze)
                          - ‚úÖ Code formatting (dart format)
                          - ‚úÖ Dependency validation

                          **Code metrics:**
                          - TODO comments: ${todoCount}
                          - FIXME comments: ${fixmeCount}
                          `;

                          github.rest.issues.createComment({
                              issue_number: context.issue.number,
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              body: comment
                          });
                      } catch (error) {
                          console.log('Could not generate quality report:', error.message);
                      }
